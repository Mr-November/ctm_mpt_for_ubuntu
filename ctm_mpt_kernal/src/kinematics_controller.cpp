#include "ctm_mpt2.h"
#include <iostream>
#include <Eigen/Dense>

int main(int argc, char** argv)
{
    // ROS initialisation.
    // *************************************************
	ros::init(argc, argv, "kinematics_controller_node");
    ros::NodeHandle nh;
    ros::Publisher xi_publisher = nh.advertise<std_msgs::Float32MultiArray>("xid", 1);
    std_msgs::Float32MultiArray xid_message;
    std_msgs::MultiArrayDimension dim;
    dim.label = "xid";
    dim.size = N_DIM*2+1;
    dim.stride = N_DIM*2+1;
    xid_message.layout.dim.push_back(dim);
    xid_message.layout.data_offset = 0;
    // *************************************************



    // Define xis.
    // *************************************************
    Eigen::Matrix<double, Eigen::Dynamic, N_DIM> xis
    {
        {0.266788072040863,-0.0501588968041427,-0.966888821325518,-0.161466681190917,1.13563589200322,0.21430089702856},
        {0.268137737489838,-0.0487622601650601,-0.969744121133203,-0.159055705500029,1.13717782696059,0.210423831721318},
        {0.269506362408701,-0.0473718910182327,-0.972636183205766,-0.156627932467159,1.13873651546156,0.206537200893325},
        {0.270847626628626,-0.0460051928117369,-0.975471339579846,-0.154147868304013,1.14026460735657,0.2026227703669},
        {0.272161496811949,-0.0446616976111094,-0.978249462919335,-0.151616537511337,1.14176202524712,0.198681089463714},
        {0.273447936023951,-0.0433409371363314,-0.980970419509105,-0.149034966038771,1.14322868893514,0.19471270806494},
        {0.274704189696989,-0.0420433963433367,-0.983628625360061,-0.146402141096646,1.14466178805297,0.190717069737202},
        {0.27592086131221,-0.040772098790136,-0.98620505814603,-0.143711728243401,1.14605171996736,0.186690783576027},
        {0.277140184332694,-0.0395110813493459,-0.988784723305353,-0.140997574973396,1.14744123953763,0.182652044581294},
        {0.278316752418893,-0.038276460244793,-0.99127613860035,-0.138225561983482,1.14878432384708,0.178582496420749},
        {0.279465636190803,-0.0370622328333299,-0.993709594202351,-0.135408447708414,1.15009619645016,0.174488998895837},
        {0.280571626774318,-0.0358728158546478,-0.996054420184047,-0.132537011649648,1.15136141118322,0.170366683907948},
        {0.281666227935327,-0.034697488175613,-0.998373976652381,-0.129633798007944,1.15261184171849,0.166227478288456},
        {0.282745661678508,-0.0335371631979107,-1.00066062277989,-0.126696941429947,1.15384364417337,0.162070392670015},
        {0.283783447336193,-0.0323997255518561,-1.00286099050451,-0.123709928056963,1.1550299413095,0.157886702765733},
        {0.284793185633771,-0.031280304979164,-1.00500240263299,-0.120683061349687,1.15618447268471,0.153681876605987},
        {0.285765957740327,-0.0301812970205442,-1.00706683450631,-0.117611364472526,1.15729813133718,0.149453321594788},
        {0.286728540993479,-0.0290935729483872,-1.00910822690789,-0.114513994763781,1.15839814524248,0.14521104061205},
        {0.287645460730369,-0.028027819564807,-1.01105501791434,-0.111368621122139,1.15944838997918,0.140943369335256},
        {0.288543080151006,-0.0269754206329595,-1.01296029038779,-0.108193389803946,1.16047561878189,0.136659861614147},
        {0.289420402762369,-0.025936474194663,-1.01482201924297,-0.104988101967805,1.16147882405934,0.132360377515585},
        {0.290258922174582,-0.0249159076791429,-1.01660277947119,-0.101742542688742,1.16243907338106,0.128039647980864},
        {0.291073517724497,-0.0239080450065051,-1.01833270379239,-0.0984685489637799,1.16337168701311,0.123703691497521},
        {0.291857463884321,-0.022915246388136,-1.01999801859923,-0.0951613424538468,1.16426958162917,0.119350208874178},
        {0.29260903755142,-0.0219371695840687,-1.02159525112544,-0.0918216307910207,1.16513103633619,0.11497949399738},
        {0.29334076216589,-0.0209698213098018,-1.02314966806338,-0.0884579197398151,1.16596880838085,0.11059607066672},
        {0.294039085446799,-0.0200163909942998,-1.02463385117015,-0.0850635089428244,1.16676904265628,0.106196379891062},
        {0.294708758850918,-0.0190750829304701,-1.02605736524955,-0.0816422417525196,1.16753656492759,0.1017824615305},
        {0.295348973565123,-0.0181458948250393,-1.02741850636727,-0.0781941614313974,1.16827048793112,0.0973543556706634},
        {0.295956272505268,-0.0172279507526128,-1.0287103800254,-0.0747212197375633,1.1689673956408,0.0929130619145616},
        {0.296539921744852,-0.0163198923072018,-1.02995153821255,-0.0712262708580943,1.1696365750448,0.0884601193803401},
        {0.297098821200451,-0.015421201565952,-1.03113976589326,-0.0677105021427002,1.1702769227781,0.0839961835865057},
        {0.297624517428503,-0.0145334397175972,-1.0322579582817,-0.0641705936631132,1.1708797944057,0.0795194182951719},
        {0.29811970993064,-0.0136541344551076,-1.03331157930767,-0.0606119606555533,1.17144797879348,0.0750327619734055},
        {0.298590038019395,-0.0127829798817105,-1.03431200718824,-0.0570351393872011,1.17198721477545,0.0705364257006748},
        {0.299028133977193,-0.0119209493531454,-1.03524425379599,-0.0534382488218665,1.17248987663435,0.0660295420660704},
        {0.299433963521727,-0.0110660480848296,-1.03610830198699,-0.0498255117271846,1.17295601573736,0.0615142100993966},
        {0.299814879993585,-0.0102180248671683,-1.03691893009603,-0.046197507015324,1.17339304346577,0.0569908256000241},
        {0.300167572979332,-0.00937641703182581,-1.03766944262809,-0.0425552501736032,1.17379759026255,0.0524598763535281},
        {0.300492559196131,-0.0085406400258643,-1.03836090789578,-0.0389000721317704,1.1741702123314,0.0479221119215393},
        {0.300786600012505,-0.00771060347774345,-1.0389867243101,-0.0352321880385508,1.17450755316726,0.043377616725722},
        {0.301045777919713,-0.00688602586873678,-1.03953897939182,-0.0315522738939309,1.17480562136128,0.0388267730697225},
        {0.301281125093051,-0.00606540307526787,-1.04003993795083,-0.0278634845496882,1.17507565900007,0.0342711778106066},
        {0.301490233204084,-0.00524847189801659,-1.04048472139669,-0.0241665489469226,1.17531519859369,0.0297113353908175},
        {0.301666224565819,-0.0044352569228521,-1.0408594345694,-0.0204613843328747,1.17551722420624,0.0251471150576379},
        {0.301812909540456,-0.00362492006620249,-1.0411717611789,-0.0167498384908816,1.17568561392871,0.0205795184135421},
        {0.301927022881276,-0.0028170898064535,-1.04141508577345,-0.0130327817462488,1.17581701585867,0.0160090424447464},
        {0.30201830755931,-0.00201078988369776,-1.04160911888561,-0.00931223855258754,1.17592141316914,0.0114366490340873},
        {0.302072602830483,-0.001206016511321,-1.04172522081768,-0.00558836716070328,1.17598431507683,0.00686253375755043},
        {0.302102059986506,-0.000401905173917629,-1.04178793524351,-0.00186301110577688,1.17601811984737,0.00228762867782409},
        {0.302102059986507,0.000401905173917667,-1.04178793524351,0.00186301110577654,1.17601811984737,-0.00228762867782421},
        {0.302072602830485,0.00120601651132078,-1.04172522081769,0.00558836716070366,1.17598431507683,-0.00686253375755082},
        {0.302017847135866,0.00201080881557934,-1.04160812714144,0.0093122167281916,1.17592088185745,-0.0114366474413192},
        {0.301930274250683,0.00281693872535967,-1.04142166550261,0.0130330700379425,1.17582034868302,-0.0160091585519919},
        {0.301812909540457,0.00362492006620241,-1.04117176117891,0.0167498384908815,1.17568561392871,-0.0205795184135422},
        {0.301666224565816,0.00443525692285223,-1.04085943456939,0.0204613843328743,1.17551722420623,-0.0251471150576377},
        {0.301485919501358,0.00524875951590651,-1.04047601041884,0.0241659484230452,1.17531080119796,-0.029711023484228},
        {0.301284952043285,0.00606508709073497,-1.04004766438722,0.0278641748863712,1.17507955991595,-0.0342715668887508},
        {0.301050400346859,0.00688562400796381,-1.03954831319458,0.0315531060808132,1.17481033470722,-0.0388271976962763},
        {0.300786600012506,0.00771060347774343,-1.0389867243101,0.0352321880385505,1.17450755316726,-0.0433776167257219},
        {0.300489158262584,0.0085409682453521,-1.03835404296918,0.0388993962499581,1.17416674829698,-0.0479217668157882},
        {0.300168640731326,0.00937631639976496,-1.03767158402642,0.0425554526350446,1.17379866402409,-0.052459974510671},
        {0.299814879879615,0.0102180248728614,-1.03691892986767,0.0461975070028313,1.17339304335159,-0.0569908255922376},
        {0.299433963521724,0.0110660480848297,-1.03610830198698,0.0498255117271842,1.17295601573735,-0.0615142100993966},
        {0.299028133977194,0.0119209493531456,-1.03524425379599,0.0534382488218661,1.17248987663435,-0.0660295420660703},
        {0.298590038019394,0.0127829798817105,-1.03431200718824,0.0570351393872009,1.17198721477545,-0.0705364257006746},
        {0.298119709930641,0.0136541344551077,-1.03331157930767,0.0606119606555528,1.17144797879348,-0.0750327619734054},
        {0.297621816224297,0.0145334119866423,-1.03225256663301,0.0641706355272523,1.17087711235637,-0.0795193999637119},
        {0.297098821200452,0.0154212015659521,-1.03113976589326,0.0677105021426997,1.1702769227781,-0.0839961835865055},
        {0.296539921744853,0.0163198923072016,-1.02995153821255,0.0712262708580945,1.1696365750448,-0.0884601193803402},
        {0.295956272505268,0.0172279507526126,-1.0287103800254,0.0747212197375635,1.1689673956408,-0.0929130619145618},
        {0.295344018132378,0.0181465823957828,-1.02740854537661,0.0781927446422182,1.16826548485403,-0.0973536056166644},
        {0.294708758850918,0.0190750829304701,-1.02605736524955,0.0816422417525197,1.16753656492759,-0.101782461530501},
        {0.294039085446801,0.0200163909942995,-1.02463385117015,0.0850635089428248,1.16676904265628,-0.106196379891062},
        {0.29334076216589,0.0209698213098019,-1.02314966806338,0.0884579197398147,1.16596880838085,-0.11059607066672},
        {0.292609037551422,0.0219371695840683,-1.02159525112544,0.0918216307910213,1.16513103633619,-0.11497949399738},
        {0.291850921869073,0.0229168925271637,-1.01998482421438,0.0951578780332104,1.16426292850361,-0.119348376497786},
        {0.291073517724498,0.023908045006505,-1.01833270379239,0.0984685489637799,1.16337168701311,-0.123703691497521},
        {0.290256262055161,0.0249164520142333,-1.01659745428284,0.101741300799957,1.16243642630467,-0.128038875884947},
        {0.289420402762369,0.025936474194663,-1.01482201924297,0.104988101967805,1.16147882405934,-0.132360377515585},
        {0.288542381000018,0.0269755335565206,-1.01295888792374,0.108193151693362,1.16047491791462,-0.136659729065091},
        {0.287644975794939,0.0280278543617058,-1.0110540339108,0.111368565064892,1.15944788920717,-0.1409433522677},
        {0.286728540993478,0.0290935729483873,-1.00910822690788,0.11451399476378,1.15839814524248,-0.145211040612049},
        {0.285774902687885,0.0301784151989096,-1.0070848692075,0.117617395147304,1.1573072375986,-0.149456466522967},
        {0.284793185633771,0.0312803049791642,-1.00500240263299,0.120683061349687,1.15618447268471,-0.153681876605987},
        {0.283783447336193,0.0323997255518561,-1.00286099050451,0.123709928056962,1.1550299413095,-0.157886702765733},
        {0.282745661678508,0.0335371631979109,-1.00066062277989,0.126696941429946,1.15384364417337,-0.162070392670015},
        {0.281666227935329,0.0346974881756124,-0.998373976652386,0.129633798007945,1.15261184171849,-0.166227478288457},
        {0.280586784497132,0.0358679247888111,-0.996084933300657,0.13254727492424,1.15137676778689,-0.170372109497701},
        {0.279465636190803,0.0370622328333298,-0.993709594202351,0.135408447708415,1.15009619645016,-0.174488998895837},
        {0.278316752418892,0.0382764602447932,-0.991276138600348,0.138225561983481,1.14878432384708,-0.178582496420749},
        {0.277140184332692,0.0395110813493465,-0.988784723305349,0.140997574973395,1.14744123953763,-0.182652044581293},
        {0.2759163725949,0.0407733802711842,-0.98619605339544,0.143709151119816,1.14604719443803,-0.186689514979474},
        {0.27468300998544,0.0420508711755801,-0.983586022978783,0.146386459616983,1.14464036826856,-0.1907087678626},
        {0.27344793602395,0.0433409371363315,-0.980970419509103,0.149034966038771,1.14322868893514,-0.19471270806494},
        {0.272133715720663,0.0446717760032039,-0.978193620682256,0.151595357271964,1.14173397406038,-0.198669842916065},
        {0.270847626628626,0.0460051928117367,-0.975471339579847,0.154147868304013,1.14026460735657,-0.2026227703669},
        {0.269474164577235,0.0473839212611633,-0.972571487742181,0.156602657816775,1.13870403434588,-0.206523775864643},
        {0.268137737489836,0.0487622601650603,-0.9697441211332,0.159055705500028,1.13717782696059,-0.210423831721318},
        {0.266788072040863,0.0501588968041427,-0.966888821325518,0.161466681190917,1.13563589200322,-0.21430089702856}
    };
    // *************************************************

    // Define ts.
    // *************************************************
    Eigen::Matrix<double, 1, Eigen::Dynamic> ts
    {
        {0,0.184247145172158,0.369213811286138,0.554936256769102,0.741389491064335,0.928548434110763,1.11639185115288,1.30491159400578,1.49400966636406,1.68373821794778,1.87404579683223,2.06489756370711,2.25628386092113,2.44818548362696,2.64055349025807,2.83336932025439,3.02660196884316,3.2202454324524,3.4142366660725,3.60858392441866,3.8032756348858,3.99824418696057,4.19346381340574,4.38892828905461,4.58459521907073,4.78046992003785,4.97648742311611,5.17263521860782,5.36889779190424,5.56517671066588,5.76155167069347,5.95797718838793,6.1543944614455,6.35072156293943,6.54703710595065,6.74326216006077,6.93930274315986,7.13525931064689,7.33105635992452,7.52667081102264,7.72204560858185,7.91710255781139,8.11194477239743,8.30651451804911,8.50070621205545,8.69453677836137,8.88793353624257,9.08100560975061,9.27352354234904,9.46563671752163,9.65725330020915,9.8483423965264,10.0389488366504,10.2289223668496,10.4182833215754,10.6070133460496,10.795004934468,10.9824744276528,11.1691526365672,11.3550942272822,11.5401847418916,11.7246032154962,11.9081295143267,12.0908541317463,12.272784956896,12.4537938121124,12.63378618755,12.8128769801785,12.9910905623596,13.1681374078948,13.3442659371598,13.5193570850216,13.6935283510418,13.8664634083728,14.039134196066,14.2122920494126,14.3857866081558,14.5594416315832,14.7336363183486,14.9079611438372,15.0828202366298,15.2577610549334,15.4327642901875,15.6081451149035,15.7837104543127,15.9594371750677,16.1353052402993,16.3115243476035,16.4873550033697,16.6634954468037,16.8396825670989,17.0158937044442,17.1924222734067,17.3686347538535,17.5443994005698,17.720905628745,17.8964655033724,18.0728279972411,18.2480912175413,18.4229598076659}
    };
    // ts = Eigen::Matrix<double, 1, Eigen::Dynamic>::LinSpaced(xis.rows(), 0.0, 193.814897133206);
    // *************************************************
    


    // Singleton.
    // *************************************************
    // ros::Duration(10).sleep();
    // xid_message.data = std::vector<float> {
    //     -0.8068,0.7879,1.2238,-1.1268,-0.3383,0.3909, 0,0,0,0,0,0, 0,0,0,0,0,0
    // };
    // xi_publisher.publish(xid_message);
    // *************************************************



    // Trajectory.
    // *************************************************
    // Interpolation.
    XiSpFunc<N_DIM> xisf(ts, xis.transpose());

    // Publish the first point before start, with zero forward dot and diff.
    ros::Duration(10).sleep();
    float time_cur = 0.0;
    const float* xi_msg_array = xisf(time_cur).data();
    xid_message.data = std::vector<float>(xi_msg_array, xi_msg_array+N_DIM*3);
    xid_message.data.push_back(1);
    std::fill(xid_message.data.begin()+N_DIM, xid_message.data.end(), 0);
    xi_publisher.publish(xid_message);
    // *************************************************

    ros::Duration(90).sleep();
    ROS_INFO("The kinematics controller is ready.");
    ros::Time time_start = ros::Time::now();
    ros::Rate loop_rate(KR);
    while (ros::ok())
    {
        time_cur = (ros::Time::now()-time_start).toSec();
        if (time_cur > ts(ts.cols()-1)) break;
        xi_msg_array = xisf(time_cur).data();
        xid_message.data = std::vector<float>(xi_msg_array, xi_msg_array+N_DIM*3);

        xid_message.data.push_back(1.0);
        
        // if (time_cur <= ts(10))
        // {
        //     xid_message.data.push_back(1.0);
        // }
        // else if (time_cur <= ts(20))
        // {
        //     xid_message.data.push_back(2.0);
        // }
        // else if (time_cur <= ts(30))
        // {
        //     xid_message.data.push_back(3.0);
        // }
        // else
        // {
        //     xid_message.data.push_back(4.0);
        // }

        xi_publisher.publish(xid_message);
        if(!loop_rate.sleep())
        {
            ROS_WARN("The kinematics controller did not meet the desired rate.");
        }
    }
    // Publish the last point after finishing, with zero forward dot and diff.
    std::fill(xid_message.data.begin()+N_DIM, xid_message.data.end(), 0);
    xi_publisher.publish(xid_message);
    ROS_INFO("Task completed.");

    return 0;
}
